<link rel="stylesheet" href="https://cdn.datatables.net/t/bs-3.3.6/jqc-1.12.0,dt-1.10.11/datatables.min.css"/> 
<script src="https://cdn.datatables.net/t/bs-3.3.6/jqc-1.12.0,dt-1.10.11/datatables.min.js"></script>
<script>
  jQuery(function($){
    $("#user-table").DataTable();
    $("#question-table").DataTable();
    $("#category-table").DataTable();
  });
</script>

<h1>管理者画面</h1>
<ul class="nav nav-tabs">
  <li class="active"><a href="#users" data-toggle="tab">ユーザ一覧</a></li>
  <li><a href="#questions" data-toggle="tab">問題一覧</a></li>
  <li><a href="#categories" data-toggle="tab">カテゴリー一覧</a></li>
  <li><a href="#situation" data-toggle="tab">最新の状況</a></li>
  <li><a href="#analysis" data-toggle="tab">統計</a></li>
</ul>

<div class="tab-content">
  <div class="tab-pane active" id="users">
    <div style="margin-top: 1em;"></div>
    <table id="user-table" class="table table-bordered" width="100%">
      <thead>
        <tr>
          <td>アカウントID</td>
          <td>ユーザネーム</td>
          <td>権限</td>
        </tr>
      </thead>
      <tbody>
        <% @users.each do |user| %>
          <tr>
            <td><%= link_to user.screen_name, admin_path(user) %></td>
            <td><%= user.user_name %></td>
            <% if user.is_admin %>
              <td>管理者</td>
            <% else %>
              <td>ユーザ</td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="tab-pane" id="questions">
    <%= link_to "問題追加", new_question_path, class: "btn btn-primary" %>
    <%= link_to "問題追加のルール",
      'https://github.com/shiotomo/code-candy/wiki/%E5%95%8F%E9%A1%8C%E4%BD%9C%E6%88%90%E6%99%82%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%AB',
      class: "btn btn-info",
      target: "_blank" %>
    <div style="margin-top: 1em;"></div>
    <table id="question-table" class="table table-bordered" width="100%">
      <thead>
        <tr>
          <td>問題名</td>
          <td>提出されたコード数</td>
          <td>詳細</td>
          <td>削除</td>
        </tr>
      </thead>
      <tbody>
        <% @questions.each do |question| %>
          <tr>
            <td><%= question.title %></td>
            <td><%= link_to question.results.all.count, list_path(question) %></td>
            <td><%= link_to "詳細",
              question_path(question),
              class: "btn btn-info"
              %></td>
            <td><%= link_to "削除",
              question_path(question),
              method: :delete,
              class: "btn btn-danger",
              data: {confirm: "本当に削除していいですか？"} %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  <div class="tab-pane" id="categories">
    <%= link_to "カテゴリー追加", new_category_path, class: "btn btn-primary" %>
    <div style="margin-top: 1em;"></div>
    <table id="category-table" class="table table-bordered" width="100%">
      <thead>
        <tr>
          <td>カテゴリー名</td>
          <td>問題数</td>
          <td>詳細</td>
          <td>削除</td>
        </tr>
      </thead>
      <tbody>
        <% @categories.each do |category| %>
          <tr>
            <td><%= category.title %></td>
            <td><%= category.category_items.all.count %></td>
            <td><%= link_to "詳細",
              category_path(category),
              class: "btn btn-info"
              %></td>
            <td><%= link_to "削除",
              category_path(category),
              method: :delete,
              class: "btn btn-danger",
              data: {confirm: "本当に削除していいですか？"} %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="tab-pane" id="situation">
    <table class="table" width="100%">
      <thead>
        <tr>
          <td>問題名</td>
          <td>解答者</td>
          <td>解答言語</td>
          <td>正誤</td>
          <td>解答時刻</td>
          <td>コード</td>
        </tr>
      </thead>
      <tbody>
        <% @results.each do |result| %>
          <tr>
            <td>
              <%= link_to result.question.title,
                question_path(result.question)
              %>
          </td>
          <td>
            <%= link_to result.user.screen_name,
              admin_path(result.user_id)
            %>
        </td>
        <td><%= result.language %></td>
        <td>
          <% if result.answer %>
            <p style="color: green">正解</p>
          <% else %>
            <p style="color: red">不正解</p>
          <% end %>
        </td>
        <td><%= result.created_at.in_time_zone('Tokyo') %></td>
        <td><button type="button" class="btn btn-primary" data-toggle="modal" data-target="#result<%= result.id %>">コード詳細</button></td>

        <div class="modal fade" id="result<%= result.id %>">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">提出コード</h4>
              </div>
              <div class="modal-body">
                <p>
                  <h5>問題名: <%= result.question.title %></h5>
                  <h5>解答者: <%= result.user.screen_name %></h5>
                  <h5>実行言語: <%= result.language %></h5>
                  <h5>提出時間: <%= result.created_at.in_time_zone('Tokyo') %></h5>
                  <h5>
                    <% if result.answer %>
                      <p style="color: green">正解</p>
                    <% else %>
                      <p style="color: red">不正解</p>
                    <% end %>
                  </h5>
                </p>
                <hr />
                <p>
                  <%= sanitize markdown(result.code).html_safe %>
                </p>
              </div>
            </div>
          </div>
        </div>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="tab-pane" id="analysis">
    <div class="row" style="margin-top: 1em;">
      <div class="col-lg-6">
        <%= pie_chart @analysis %>
      </div>

      <div class="col-lg-6">
        <table class="table">
          <thead>
            <tr>
              <td>プログラミング言語</td>
              <td>提出数</td>
            </tr>
          </thead>
          <tbody>
            <% @analysis.each do |ana| %>
              <tr>
                <td><%= ana[0] %></td>
                <td><%= ana[1] %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
